--- START OF FILE index.tsx ---

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

--- END OF FILE index.tsx ---


--- START OF FILE metadata.json ---

{
  "name": "EduNexus AI",
  "description": "An AI-powered, industry-grade education management platform for teachers, students, and parents. It features attendance and marks management, AI-driven study scheduling, and seamless communication tools.",
  "requestFramePermissions": []
}

--- END OF FILE metadata.json ---


--- START OF FILE index.html ---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduNexus AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        /* Default theme (light-white), will be overridden by ThemeContext */
        --primary-color: 96 165 250;
        --primary-color-dark: 59 130 246;
        --background-color: 243 244 246;
        --foreground-color: 255 255 255;
        --subtle-background-color: 249 250 251;
        --text-color: 17 24 39;
        --text-secondary-color: 75 85 99;
        --primary-text-color: 255 255 255;
        --border-color: 229 231 235;
        --ring-color: 96 165 250;

        --danger-color: 239 68 68;
        --danger-color-dark: 220 38 38;
        --danger-subtle-color: 254 226 226;
        --danger-text-color: 153 27 27;
        
        --success-color: 34 197 94;
        --success-subtle-color: 220 252 231;
        --success-text-color: 21 128 61;
        
        --warning-color: 234 179 8;
        --warning-subtle-color: 254 249 195;
        --warning-text-color: 180 83 9;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.6",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1"
  }
}
</script>
</head>
  <body class="bg-[rgb(var(--background-color))] text-[rgb(var(--text-color))]">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>

--- END OF FILE index.html ---


--- START OF FILE App.tsx ---

import React from 'react';
import { HashRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './context/AuthContext';
import { DataProvider } from './context/DataContext';
import { ThemeProvider } from './context/ThemeContext';
import LoginPage from './pages/Login';
import Dashboard from './pages/Dashboard';

const App: React.FC = () => {
  return (
    <AuthProvider>
      <DataProvider>
        <ThemeProvider>
          <HashRouter>
            <Routes>
              <Route path="/login" element={<LoginPage />} />
              <Route 
                path="/dashboard" 
                element={
                  <PrivateRoute>
                    <Dashboard />
                  </PrivateRoute>
                } 
              />
              <Route path="*" element={<Navigate to="/login" />} />
            </Routes>
          </HashRouter>
        </ThemeProvider>
      </DataProvider>
    </AuthProvider>
  );
};

const PrivateRoute: React.FC<{ children: React.ReactElement }> = ({ children }) => {
  const { user } = useAuth();
  return user ? children : <Navigate to="/login" />;
};


export default App;

--- END OF FILE App.tsx ---


--- START OF FILE types.ts ---

export enum UserRole {
  Teacher = 'teacher',
  Student = 'student',
  Parent = 'parent',
  Dean = 'dean'
}

export interface Institute {
  id: string;
  name: string;
}

export interface Department {
  id: string;
  name: string;
  instituteId: string;
}

export interface User {
  id: string;
  name: string;
  email: string;
  role: UserRole;
}

export interface Student extends User {
  role: UserRole.Student;
  parentId: string;
  classId: string;
}

export interface Teacher extends User {
  role: UserRole.Teacher;
  department: string;
  instituteId: string;
  reportingToId: string; // HOD's ID
}

export interface Dean extends User { // Represents HOD
  role: UserRole.Dean;
  department: string;
  instituteId: string;
}

export interface Parent extends User {
  role: UserRole.Parent;
  childIds: string[];
}

export type LoggedInUser = Student | Teacher | Parent | Dean;

export interface Class {
  id: string;
  name: string;
  teacherIds: string[];
  studentIds: string[];
}

export interface AttendanceRecord {
  studentId: string;
  date: string; // YYYY-MM-DD
  status: 'present' | 'absent';
}

export interface Mark {
  studentId: string;
  subject: string;
  exam: string;
  marks: number;
  maxMarks: number;
}

export interface Announcement {
  id: string;
  teacherId: string;
  teacherName: string;
  content: string;
  timestamp: string; // ISO 8601
}

export interface StudySession {
  subject: string;
  topic: string;
  startTime: string;
  endTime: string;
  reason: string;
}

export interface Message {
  id: string;
  senderId: string;
  senderName: string;
  content: string;
  timestamp: string; // ISO 8601
  targetType: 'class' | 'department';
  targetId: string; // classId or department name
  readBy: string[];
}

export interface Task {
  id: string;
  title: string;
  description: string;
  classId: string;
  creatorId: string; // teacher's id
  dueDate: string; // ISO 8601
  priority: 'High' | 'Medium' | 'Low';
}

export interface StudentTask {
  id: string; // unique student-task assignment id
  taskId: string;
  studentId: string;
  status: 'To Do' | 'In Progress' | 'Completed';
  completedDate?: string; // ISO 8601
}

--- END OF FILE types.ts ---


--- START OF FILE constants.ts ---

import { UserRole } from './types';

export const ROLES = [
  { id: UserRole.Teacher, name: 'Teacher' },
  { id: UserRole.Student, name: 'Student' },
  { id: UserRole.Parent, name: 'Parent' },
];

export const ATTENDANCE_THRESHOLD = 75;

--- END OF FILE constants.ts ---


--- START OF FILE data/mock.ts ---

import { Student, Teacher, Parent, Dean, UserRole, Class, AttendanceRecord, Mark, Announcement, Institute, Department, Message, Task, StudentTask } from '../types';

export const mockInstitutes: Institute[] = [
  { id: 'inst1', name: 'Greenwood University' },
  { id: 'inst2', name: 'Oakridge Institute of Technology' },
];

export const mockDepartments: Department[] = [
  { id: 'dept1', name: 'Computer Science', instituteId: 'inst1' },
  { id: 'dept2', name: 'Business Administration', instituteId: 'inst1' },
  { id: 'dept3', name: 'Mechanical Engineering', instituteId: 'inst2' },
];

export const mockUsers: (Student | Teacher | Parent | Dean)[] = [
  // HODs (Deans)
  { id: 'dean1', name: 'Dr. Evelyn Reed', email: 'dean.reed@university.edu', role: UserRole.Dean, department: 'Computer Science', instituteId: 'inst1' },
  { id: 'dean2', name: 'Dr. Samuel Chen', email: 'dean.chen@university.edu', role: UserRole.Dean, department: 'Business Administration', instituteId: 'inst1' },
  { id: 'dean3', name: 'Dr. Maria Garcia', email: 'dean.garcia@tech.edu', role: UserRole.Dean, department: 'Mechanical Engineering', instituteId: 'inst2' },
  
  // Professors (Teachers)
  { id: 'teacher1', name: 'Mr. Alan Grant', email: 'alan.grant@university.edu', role: UserRole.Teacher, department: 'Computer Science', instituteId: 'inst1', reportingToId: 'dean1' },
  { id: 'teacher2', name: 'Ms. Laura Dern', email: 'laura.dern@university.edu', role: UserRole.Teacher, department: 'Computer Science', instituteId: 'inst1', reportingToId: 'dean1' },
  { id: 'teacher3', name: 'Mr. Jeff Goldblum', email: 'jeff.goldblum@tech.edu', role: UserRole.Teacher, department: 'Mechanical Engineering', instituteId: 'inst2', reportingToId: 'dean3' },

  // Students
  { id: 'student1', name: 'John Doe', email: 'john.doe@university.edu', role: UserRole.Student, parentId: 'parent1', classId: 'cs101' },
  { id: 'student2', name: 'Jane Smith', email: 'jane.smith@university.edu', role: UserRole.Student, parentId: 'parent1', classId: 'cs101' },
  { id: 'student3', name: 'Peter Jones', email: 'peter.jones@university.edu', role: UserRole.Student, parentId: 'parent2', classId: 'cs101' },
  
  // Parents
  { id: 'parent1', name: 'David Doe', email: 'john.doe@university.edu', role: UserRole.Parent, childIds: ['student1', 'student2'] },
  { id: 'parent2', name: 'Mary Jones', email: 'peter.jones@university.edu', role: UserRole.Parent, childIds: ['student3'] },
];

export const mockClasses: Class[] = [
  { id: 'cs101', name: 'BCA 5th Sem', teacherIds: ['teacher1', 'dean1'], studentIds: ['student1', 'student2', 'student3'] },
  { id: 'bcom202', name: 'B.Com 3rd Sem', teacherIds: ['dean2'], studentIds: [] },
];

export const mockAttendance: AttendanceRecord[] = [
  { studentId: 'student1', date: '2024-07-20', status: 'present' },
  { studentId: 'student1', date: '2024-07-21', status: 'present' },
  { studentId: 'student1', date: '2024-07-22', status: 'absent' },
  { studentId: 'student1', date: '2024-07-23', status: 'present' },
  { studentId: 'student1', date: '2024-07-24', status: 'present' },
  { studentId: 'student2', date: '2024-07-20', status: 'present' },
  { studentId: 'student2', date: '2024-07-21', status: 'present' },
  { studentId: 'student2', date: '2024-07-22', status: 'present' },
  { studentId: 'student2', date: '2024-07-23', status: 'present' },
  { studentId: 'student2', date: '2024-07-24', status: 'present' },
  { studentId: 'student3', date: '2024-07-20', status: 'present' },
  { studentId: 'student3', date: '2024-07-21', status: 'absent' },
  { studentId: 'student3', date: '2024-07-22', status: 'absent' },
  { studentId: 'student3', date: '2024-07-23', status: 'present' },
  { studentId: 'student3', date: '2024-07-24', status: 'absent' },
];

export const mockMarks: Mark[] = [
  { studentId: 'student1', subject: 'Data Structures', exam: 'Midterm 1', marks: 85, maxMarks: 100 },
  { studentId: 'student1', subject: 'Algorithms', exam: 'Midterm 1', marks: 60, maxMarks: 100 },
  { studentId: 'student1', subject: 'Database Systems', exam: 'Midterm 1', marks: 92, maxMarks: 100 },
  { studentId: 'student2', subject: 'Data Structures', exam: 'Midterm 1', marks: 95, maxMarks: 100 },
  { studentId: 'student2', subject: 'Algorithms', exam: 'Midterm 1', marks: 88, maxMarks: 100 },
  { studentId: 'student2', subject: 'Database Systems', exam: 'Midterm 1', marks: 90, maxMarks: 100 },
  { studentId: 'student3', subject: 'Data Structures', exam: 'Midterm 1', marks: 72, maxMarks: 100 },
  { studentId: 'student3', subject: 'Algorithms', exam: 'Midterm 1', marks: 55, maxMarks: 100 },
  { studentId: 'student3', subject: 'Database Systems', exam: 'Midterm 1', marks: 68, maxMarks: 100 },
];

export const mockAnnouncements: Announcement[] = [
    { id: 'ann1', teacherId: 'dean1', teacherName: 'Dr. Evelyn Reed', content: 'Midterm exams are scheduled for next month. Please prepare accordingly.', timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() },
    { id: 'ann2', teacherId: 'teacher1', teacherName: 'Mr. Alan Grant', content: 'The submission deadline for the Data Structures project has been extended to this Friday.', timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString() }
];

export const mockMessages: Message[] = [
    { 
        id: 'msg1', 
        senderId: 'dean1', 
        senderName: 'Dr. Evelyn Reed',
        content: 'Reminder: All faculty members of the Computer Science department are required to attend the meeting tomorrow at 10 AM.',
        timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
        targetType: 'department',
        targetId: 'Computer Science',
        readBy: ['teacher1', 'teacher2']
    },
    { 
        id: 'msg2', 
        senderId: 'teacher1', 
        senderName: 'Mr. Alan Grant',
        content: 'The assignment submission portal for CS101 will be closed tonight at 11:59 PM. Please submit your work on time.',
        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
        targetType: 'class',
        targetId: 'cs101',
        readBy: []
    }
];

export const mockTasks: Task[] = [
  {
    id: 'task1',
    title: 'Data Structures Assignment 1',
    description: 'Implement a binary search tree and its traversal methods (in-order, pre-order, post-order). Submit your code and a report explaining your implementation.',
    classId: 'cs101',
    creatorId: 'teacher1',
    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
    priority: 'High',
  },
  {
    id: 'task2',
    title: 'Read Chapter 5 of Algorithms Textbook',
    description: 'Read the chapter on Dynamic Programming and summarize the key concepts. Provide at least three examples of problems that can be solved using this technique.',
    classId: 'cs101',
    creatorId: 'dean1',
    dueDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
    priority: 'Medium',
  },
];

export const mockStudentTasks: StudentTask[] = [
  // Task 1 assigned to all students in cs101
  { id: 'stask1', taskId: 'task1', studentId: 'student1', status: 'In Progress' },
  { id: 'stask2', taskId: 'task1', studentId: 'student2', status: 'To Do' },
  { id: 'stask3', taskId: 'task1', studentId: 'student3', status: 'To Do' },
  // Task 2 assigned to student1 and student2
  { id: 'stask4', taskId: 'task2', studentId: 'student1', status: 'Completed', completedDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() },
  { id: 'stask5', taskId: 'task2', studentId: 'student2', status: 'In Progress' },
  { id: 'stask6', taskId: 'task2', studentId: 'student3', status: 'To Do' },
];

--- END OF FILE data/mock.ts ---


--- START OF FILE context/AuthContext.tsx ---

import React, { createContext, useState, useContext, ReactNode } from 'react';
import { LoggedInUser, UserRole, Student, Teacher, Parent } from '../types';
import { mockUsers } from '../data/mock';

interface AuthContextType {
  user: LoggedInUser | null;
  login: (email: string, role: UserRole) => boolean;
  logout: () => void;
  signUpAsGuest: (role: UserRole) => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<LoggedInUser | null>(null);

  const login = (email: string, role: UserRole) => {
    // In a real app, this would be an API call. We use mock data here.
    // Parent login uses the child's email.
    const userToFind = mockUsers.find(
      (u) => u.email.toLowerCase() === email.toLowerCase() && (u.role === role || (role === UserRole.Parent && u.role === UserRole.Student))
    );
    
    if (userToFind) {
      if (role === UserRole.Parent) {
         const parentUser = mockUsers.find(u => u.role === UserRole.Parent && u.email.toLowerCase() === email.toLowerCase());
         if(parentUser) {
            setUser(parentUser as LoggedInUser);
            return true;
         }
      } else {
        setUser(userToFind as LoggedInUser);
        return true;
      }
    }
    
    // Dean can also login via teacher portal
    if (role === UserRole.Teacher) {
      const deanUser = mockUsers.find(u => u.email.toLowerCase() === email.toLowerCase() && u.role === UserRole.Dean);
      if(deanUser) {
        setUser(deanUser as LoggedInUser);
        return true;
      }
    }

    return false;
  };

  const signUpAsGuest = (role: UserRole) => {
    let guestUser: LoggedInUser | undefined;
    switch (role) {
      case UserRole.Teacher:
        guestUser = mockUsers.find(u => u.id === 'teacher1') as Teacher;
        break;
      case UserRole.Parent:
        guestUser = mockUsers.find(u => u.id === 'parent1') as Parent;
        break;
      case UserRole.Student:
      default:
        guestUser = mockUsers.find(u => u.id === 'student1') as Student;
        break;
    }
    if (guestUser) {
      setUser(guestUser);
    }
  };

  const logout = () => {
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, signUpAsGuest }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

--- END OF FILE context/AuthContext.tsx ---


--- START OF FILE hooks/useAuth.ts ---

// This is a re-export of useAuth from the context file.
// In larger apps, it's good practice to have hooks in a separate directory.
export { useAuth } from '../context/AuthContext';

--- END OF FILE hooks/useAuth.ts ---


--- START OF FILE services/geminiService.ts ---

import { GoogleGenAI, Type } from "@google/genai";
import { Mark, StudySession } from '../types';

const API_KEY = process.env.API_KEY;

// Initialize ai client as null and only create an instance if API_KEY is available.
let ai: GoogleGenAI | null = null;

if (!API_KEY) {
  // This is a placeholder check. In a real environment, the key would be set.
  console.warn("Gemini API key not found. AI features will be disabled.");
} else {
  // Only instantiate the client if the API key is available to prevent crashes.
  ai = new GoogleGenAI({ apiKey: API_KEY });
}

export const generateStudySchedule = async (marks: Mark[], availableSlots: string[]): Promise<StudySession[]> => {
  // Use the existence of the 'ai' client as the condition for using the API.
  if (!ai) {
    // Return a mock schedule if the client is not initialized
    console.log("Using mock schedule data.");
    return [
      { subject: 'Algorithms', topic: 'Review Big O Notation', startTime: '09:00', endTime: '10:00', reason: 'This is a weak area based on recent marks.' },
      { subject: 'Data Structures', topic: 'Practice with Trees', startTime: '11:00', endTime: '12:00', reason: 'Reinforce concepts for the upcoming exam.' },
      { subject: 'Break', topic: 'Take a break', startTime: '12:00', endTime: '13:00', reason: 'Rest is important.' },
      { subject: 'Database Systems', topic: 'SQL Query Practice', startTime: '13:00', endTime: '14:00', reason: 'Consistent performance, good for review.' }
    ];
  }

  const marksSummary = marks.map(m => `- ${m.subject}: ${m.marks}/${m.maxMarks}`).join('\n');
  const availableSlotsSummary = availableSlots.join(', ');

  const prompt = `
    You are an expert academic advisor. Your task is to create a personalized, one-day study schedule for a student based on their recent performance and available time slots.
    Prioritize subjects where the student has lower marks (weak areas). Use principles of spaced repetition and active recall.
    
    Student's Performance:
    ${marksSummary}

    Available Study Slots for Today:
    ${availableSlotsSummary}

    Generate a schedule with specific topics to study for each session. For each session, provide a brief reason for its inclusion and priority. Keep sessions to about 50-60 minutes and include short breaks.
    
    Output the schedule in the specified JSON format. Do not include any other text or markdown formatting.
  `;

  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.ARRAY,
          items: {
            type: Type.OBJECT,
            properties: {
              subject: { type: Type.STRING },
              topic: { type: Type.STRING },
              startTime: { type: Type.STRING },
              endTime: { type: Type.STRING },
              reason: { type: Type.STRING }
            },
            required: ["subject", "topic", "startTime", "endTime", "reason"]
          }
        }
      }
    });

    const jsonText = response.text.trim();
    return JSON.parse(jsonText) as StudySession[];

  } catch (error) {
    console.error("Error generating study schedule with Gemini API:", error);
    // Fallback to mock data in case of an API error
    return [
      { subject: 'Error', topic: 'Could not generate schedule.', startTime: 'N/A', endTime: 'N/A', reason: 'An error occurred while contacting the AI service.' }
    ];
  }
};

--- END OF FILE services/geminiService.ts ---


--- START OF FILE components/ui/Card.tsx ---

import React from 'react';

interface CardProps {
  children: React.ReactNode;
  className?: string;
}

const Card: React.FC<CardProps> = ({ children, className = '' }) => {
  return (
    <div className={`bg-[rgb(var(--foreground-color))] shadow-lg rounded-xl p-6 ${className}`}>
      {children}
    </div>
  );
};

export default Card;

--- END OF FILE components/ui/Card.tsx ---


--- START OF FILE components/ui/Button.tsx ---

import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode;
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'sm' | 'md' | 'lg';
}

const Button: React.FC<ButtonProps> = ({ children, variant = 'primary', size = 'md', className, ...props }) => {
  const baseStyles = "font-bold rounded-lg focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed";

  const variantStyles = {
    primary: "bg-[rgb(var(--primary-color))] hover:bg-[rgb(var(--primary-color-dark))] text-[rgb(var(--primary-text-color))] focus:ring-[rgb(var(--ring-color))]",
    secondary: "bg-[rgba(var(--text-secondary-color),0.1)] hover:bg-[rgba(var(--text-secondary-color),0.2)] text-[rgb(var(--text-color))] focus:ring-[rgb(var(--ring-color))]",
    danger: "bg-[rgb(var(--danger-color))] hover:bg-[rgb(var(--danger-color-dark))] text-[rgb(var(--primary-text-color))] focus:ring-[rgb(var(--danger-color))]",
  };

  const sizeStyles = {
    sm: "py-1 px-2 text-sm",
    md: "py-2 px-4",
    lg: "py-3 px-6 text-lg",
  };

  return (
    <button className={`${baseStyles} ${sizeStyles[size]} ${variantStyles[variant]} ${className}`} {...props}>
      {children}
    </button>
  );
};

export default Button;

--- END OF FILE components/ui/Button.tsx ---


--- START OF FILE components/ui/Input.tsx ---

import React from 'react';

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
}

const Input: React.FC<InputProps> = ({ label, id, ...props }) => {
  return (
    <div>
      {label && <label htmlFor={id} className="block mb-2 text-sm font-medium text-[rgb(var(--text-color))]">{label}</label>}
      <input
        id={id}
        className="bg-[rgba(var(--text-color),0.02)] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] placeholder:text-[rgb(var(--text-secondary-color))] sm:text-sm rounded-lg focus:ring-1 focus:ring-[rgb(var(--ring-color))] focus:border-[rgb(var(--primary-color))] block w-full p-2.5"
        {...props}
      />
    </div>
  );
};

export default Input;

--- END OF FILE components/ui/Input.tsx ---


--- START OF FILE components/charts/AttendanceBarChart.tsx ---

import React from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } from 'recharts';
import { ATTENDANCE_THRESHOLD } from '../../constants';

interface ChartData {
  name: string;
  attendance: number;
}

interface AttendanceBarChartProps {
  data: ChartData[];
}

const CustomTooltip = ({ active, payload, label }: any) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-[rgb(var(--foreground-color))] p-2 border border-[rgb(var(--border-color))] rounded-lg shadow-lg">
        <p className="font-bold text-[rgb(var(--text-color))]">{label}</p>
        <p className="text-[rgb(var(--primary-color))]">{`Attendance: ${payload[0].value}%`}</p>
      </div>
    );
  }
  return null;
};


const AttendanceBarChart: React.FC<AttendanceBarChartProps> = ({ data }) => {
  return (
    <ResponsiveContainer width="100%" height={300}>
      <BarChart data={data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" stroke="rgba(128, 128, 128, 0.3)" />
        <XAxis dataKey="name" stroke="rgb(var(--text-secondary-color))" />
        <YAxis unit="%" stroke="rgb(var(--text-secondary-color))" />
        <Tooltip content={<CustomTooltip />} />
        <Legend />
        <Bar dataKey="attendance" name="Attendance (%)">
          {data.map((entry, index) => (
            <Cell key={`cell-${index}`} fill={entry.attendance < ATTENDANCE_THRESHOLD ? '#ef4444' : 'rgb(var(--primary-color))'} />
          ))}
        </Bar>
      </BarChart>
    </ResponsiveContainer>
  );
};

export default AttendanceBarChart;

--- END OF FILE components/charts/AttendanceBarChart.tsx ---


--- START OF FILE components/charts/SubjectPieChart.tsx ---

import React from 'react';
import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from 'recharts';

interface ChartData {
  name: string;
  value: number;
}

interface SubjectPieChartProps {
  data: ChartData[];
}

const COLORS = ['#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7'];

const RADIAN = Math.PI / 180;
const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent }: any) => {
  const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
  const x = cx + radius * Math.cos(-midAngle * RADIAN);
  const y = cy + radius * Math.sin(-midAngle * RADIAN);

  return (
    <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central">
      {`${(percent * 100).toFixed(0)}%`}
    </text>
  );
};

const SubjectPieChart: React.FC<SubjectPieChartProps> = ({ data }) => {
  return (
    <ResponsiveContainer width="100%" height={300}>
      <PieChart>
        <Pie
          data={data}
          cx="50%"
          cy="50%"
          labelLine={false}
          label={renderCustomizedLabel}
          outerRadius={100}
          fill="#8884d8"
          dataKey="value"
          nameKey="name"
        >
          {data.map((entry, index) => (
            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
          ))}
        </Pie>
        <Tooltip />
        <Legend />
      </PieChart>
    </ResponsiveContainer>
  );
};

export default SubjectPieChart;

--- END OF FILE components/charts/SubjectPieChart.tsx ---


--- START OF FILE pages/Login.tsx ---

import React, { useState, useMemo, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import { UserRole, Dean } from '../types';
import { ROLES } from '../constants';
import { mockInstitutes, mockDepartments, mockUsers } from '../data/mock';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import Card from '../components/ui/Card';
import Select from '../components/ui/Select';

const LoginPage: React.FC = () => {
  const [activeRole, setActiveRole] = useState<UserRole>(UserRole.Student);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  
  // State for teacher hierarchy
  const [selectedInstituteId, setSelectedInstituteId] = useState('');
  const [teacherSubRole, setTeacherSubRole] = useState<'hod' | 'professor' | ''>('');
  const [selectedDepartmentId, setSelectedDepartmentId] = useState('');
  const [selectedHodId, setSelectedHodId] = useState('');

  const navigate = useNavigate();
  const { login, signUpAsGuest } = useAuth();

  // Reset hierarchy on role change
  useEffect(() => {
    setEmail('');
    setPassword('');
    setError('');
    setSelectedInstituteId('');
    setTeacherSubRole('');
    setSelectedDepartmentId('');
    setSelectedHodId('');
  }, [activeRole]);

  const handleLogin = (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    if (login(email, activeRole)) {
      navigate('/dashboard');
    } else {
      setError('Invalid credentials. Please try again.');
    }
  };

  const handleSignUp = () => {
    signUpAsGuest(activeRole);
    navigate('/dashboard');
  };

  const handleInstituteChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setSelectedInstituteId(e.target.value);
    setTeacherSubRole('');
    setSelectedDepartmentId('');
    setSelectedHodId('');
  };

  const handleSubRoleClick = (subRole: 'hod' | 'professor') => {
    setTeacherSubRole(subRole);
    setSelectedDepartmentId('');
    setSelectedHodId('');
  };

  // Memoized data for dropdowns
  const departmentsForInstitute = useMemo(() => {
    return selectedInstituteId ? mockDepartments.filter(d => d.instituteId === selectedInstituteId) : [];
  }, [selectedInstituteId]);

  const hodsForInstitute = useMemo(() => {
    return selectedInstituteId ? mockUsers.filter(u => u.role === UserRole.Dean && (u as Dean).instituteId === selectedInstituteId) as Dean[] : [];
  }, [selectedInstituteId]);

  const isLoginFormVisible =
    activeRole === UserRole.Student ||
    activeRole === UserRole.Parent ||
    (activeRole === UserRole.Teacher && teacherSubRole === 'hod' && !!selectedDepartmentId) ||
    (activeRole === UserRole.Teacher && teacherSubRole === 'professor' && !!selectedHodId);
    
  const teacherFlow = (
    <div className="space-y-4 mb-6">
      <Select
        id="institute"
        label="Select Institute"
        value={selectedInstituteId}
        onChange={handleInstituteChange}
      >
        <option value="">-- Choose an Institute --</option>
        {mockInstitutes.map(inst => <option key={inst.id} value={inst.id}>{inst.name}</option>)}
      </Select>

      {selectedInstituteId && (
        <div>
          <label className="block mb-2 text-sm font-medium text-[rgb(var(--text-color))]">Select Role</label>
          <div className="flex space-x-2">
            <Button type="button" onClick={() => handleSubRoleClick('hod')} variant={teacherSubRole === 'hod' ? 'primary' : 'secondary'} className="flex-1">HOD</Button>
            <Button type="button" onClick={() => handleSubRoleClick('professor')} variant={teacherSubRole === 'professor' ? 'primary' : 'secondary'} className="flex-1">Professor</Button>
          </div>
        </div>
      )}

      {teacherSubRole === 'hod' && (
        <Select
          id="department"
          label="Select Department"
          value={selectedDepartmentId}
          onChange={(e) => setSelectedDepartmentId(e.target.value)}
        >
          <option value="">-- Choose a Department --</option>
          {departmentsForInstitute.map(dept => <option key={dept.id} value={dept.id}>{dept.name}</option>)}
        </Select>
      )}

      {teacherSubRole === 'professor' && (
        <Select
          id="hod"
          label="Select Your HOD"
          value={selectedHodId}
          onChange={(e) => setSelectedHodId(e.target.value)}
        >
          <option value="">-- Choose your HOD --</option>
          {hodsForInstitute.map(hod => <option key={hod.id} value={hod.id}>{hod.name} ({hod.department})</option>)}
        </Select>
      )}
    </div>
  );

  return (
    <div className="min-h-screen flex items-center justify-center bg-[rgb(var(--background-color))] px-4">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h1 className="text-center text-4xl font-extrabold text-[rgb(var(--text-color))]">
            EduNexus AI
          </h1>
          <p className="mt-2 text-center text-sm text-[rgb(var(--text-secondary-color))]">
            Sign in to your account
          </p>
        </div>

        <Card>
          <div className="flex justify-around mb-6 border-b border-[rgb(var(--border-color))]">
            {ROLES.map((role) => (
              <button
                key={role.id}
                onClick={() => setActiveRole(role.id)}
                className={`flex-1 py-3 text-sm font-medium transition-colors duration-200 ${
                  activeRole === role.id
                    ? 'text-[rgb(var(--primary-color))] border-b-2 border-[rgb(var(--primary-color))]'
                    : 'text-[rgb(var(--text-secondary-color))] hover:text-[rgb(var(--text-color))]'
                }`}
              >
                {role.name}
              </button>
            ))}
          </div>

          {activeRole === UserRole.Teacher && teacherFlow}
          
          {isLoginFormVisible && (
            <form className="space-y-6" onSubmit={handleLogin}>
              <Input
                id="email"
                label="Email address"
                type="email"
                name="email"
                autoComplete="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
              <Input
                id="password"
                label="Password"
                type="password"
                name="password"
                autoComplete="current-password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
              
              {error && <p className="text-sm text-red-500">{error}</p>}
              
              <div className="flex items-center justify-between">
                <div className="text-sm">
                  <a href="#" className="font-medium text-[rgb(var(--primary-color))] hover:text-[rgb(var(--primary-color-dark))]">
                    Forgot your password?
                  </a>
                </div>
              </div>

              <div>
                <Button type="submit" className="w-full">
                  Sign in as {ROLES.find(r => r.id === activeRole)?.name}
                </Button>
              </div>
            </form>
          )}

          <div className="text-center mt-6">
            <p className="text-sm text-[rgb(var(--text-secondary-color))]">
              Don't have an account?{' '}
              <button 
                onClick={handleSignUp} 
                className="font-medium text-[rgb(var(--primary-color))] hover:text-[rgb(var(--primary-color-dark))] focus:outline-none bg-transparent border-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                disabled={activeRole === UserRole.Teacher && !isLoginFormVisible}
              >
                Sign up
              </button>
            </p>
          </div>
        </Card>
      </div>
    </div>
  );
};

export default LoginPage;

--- END OF FILE pages/Login.tsx ---


--- START OF FILE components/Layout.tsx ---

import React, { useState } from 'react';
import { useAuth } from '../hooks/useAuth';
import { useNavigate } from 'react-router-dom';
import ThemeSwitcher from './ThemeSwitcher';
import { useData } from '../context/DataContext';

interface LayoutProps {
  children: React.ReactNode;
  navItems: { name: string; icon: React.ReactElement }[];
  activeItem: string;
  setActiveItem: (item: string) => void;
  setShowMessages?: (show: boolean) => void;
}

const Icon = ({ path, className }: { path: string, className?: string }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={`w-6 h-6 ${className}`}>
        <path strokeLinecap="round" strokeLinejoin="round" d={path} />
    </svg>
);

const Layout: React.FC<LayoutProps> = ({ children, navItems, activeItem, setActiveItem, setShowMessages }) => {
  const { user, logout } = useAuth();
  const { messages } = useData();
  const navigate = useNavigate();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const handleLogout = () => {
    logout();
    navigate('/login');
  };
  
  const roleName = user?.role.charAt(0).toUpperCase() + user?.role.slice(1);

  const unreadMessagesCount = messages.filter(m => !m.readBy.includes(user?.id ?? '')).length;

  return (
    <div className="flex h-screen bg-[rgb(var(--background-color))] text-[rgb(var(--text-color))]">
      {/* Sidebar */}
      <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-[rgb(var(--foreground-color))] shadow-xl transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:flex md:flex-shrink-0`}>
        <div className="flex flex-col h-full">
          <div className="h-20 flex items-center justify-center bg-[rgba(var(--primary-color),0.05)]">
            <h1 className="text-2xl font-bold text-[rgb(var(--primary-color))]">EduNexus AI</h1>
          </div>
          <nav className="flex-1 px-2 py-4 space-y-2">
            {navItems.map((item) => (
              <button
                key={item.name}
                onClick={() => {
                  setActiveItem(item.name);
                  if (setShowMessages) setShowMessages(false);
                }}
                className={`flex items-center w-full px-4 py-2 text-left rounded-lg transition-colors duration-200 ${
                  activeItem === item.name
                    ? 'bg-[rgb(var(--primary-color))] text-[rgb(var(--primary-text-color))]'
                    : 'hover:bg-[rgba(var(--primary-color),0.1)]'
                }`}
              >
                {item.icon}
                <span className="ml-3">{item.name}</span>
              </button>
            ))}
          </nav>
           <div className="p-4 border-t border-[rgb(var(--border-color))]">
             <button onClick={handleLogout} className="flex items-center w-full px-4 py-2 text-left rounded-lg transition-colors duration-200 hover:bg-[rgb(var(--danger-subtle-color))] text-[rgb(var(--danger-color))]">
                <Icon path="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                <span className="ml-3">Logout</span>
             </button>
           </div>
        </div>
      </aside>
      
      {/* Overlay for mobile */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 z-20 bg-black opacity-50 md:hidden"
          onClick={() => setSidebarOpen(false)}
        ></div>
      )}

      {/* Main content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex items-center justify-between h-20 px-6 bg-[rgb(var(--foreground-color))] border-b border-[rgb(var(--border-color))]">
          <button onClick={() => setSidebarOpen(!sidebarOpen)} className="md:hidden text-[rgb(var(--text-secondary-color))] focus:outline-none">
             <Icon path="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </button>
          <div className="flex items-center">
            {/* Header Content can go here */}
          </div>
          <div className="flex items-center gap-4">
            <ThemeSwitcher />
            {setShowMessages && (
              <button onClick={() => setShowMessages(true)} className="relative text-[rgb(var(--text-secondary-color))] hover:text-[rgb(var(--text-color))]">
                <Icon path="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                {unreadMessagesCount > 0 && (
                  <span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-[rgb(var(--danger-color))] text-xs font-bold text-[rgb(var(--primary-text-color))]">
                    {unreadMessagesCount}
                  </span>
                )}
              </button>
            )}
            <div className="text-right">
                <p className="font-semibold">{user?.name}</p>
                <p className="text-sm text-[rgb(var(--text-secondary-color))]">{roleName}</p>
            </div>
             <img className="w-10 h-10 rounded-full" src={`https://i.pravatar.cc/150?u=${user?.id}`} alt="User Avatar" />
          </div>
        </header>
        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-[rgb(var(--background-color))] p-6">
          {children}
        </main>
      </div>
    </div>
  );
};

export default Layout;

--- END OF FILE components/Layout.tsx ---


--- START OF FILE pages/Dashboard.tsx ---

import React from 'react';
import { useAuth } from '../hooks/useAuth';
import { UserRole } from '../types';
import TeacherDashboard from '../components/teacher/TeacherDashboard';
import StudentDashboard from '../components/student/StudentDashboard';
import ParentDashboard from '../components/parent/ParentDashboard';

const Dashboard: React.FC = () => {
  const { user } = useAuth();

  if (!user) {
    return <div>Loading user data...</div>;
  }

  switch (user.role) {
    case UserRole.Teacher:
    case UserRole.Dean:
      return <TeacherDashboard />;
    case UserRole.Student:
      return <StudentDashboard />;
    case UserRole.Parent:
      return <ParentDashboard />;
    default:
      return <div>Unknown user role.</div>;
  }
};

export default Dashboard;

--- END OF FILE pages/Dashboard.tsx ---


--- START OF FILE components/teacher/TeacherDashboard.tsx ---

import React, { useState, useMemo } from 'react';
import Layout from '../Layout';
import { useAuth } from '../../hooks/useAuth';
import { useData } from '../../context/DataContext';
import { UserRole, Class, Student as StudentType, Task, StudentTask } from '../../types';
import Card from '../ui/Card';
import Button from '../ui/Button';
import Select from '../ui/Select';
import MessagesView from '../shared/MessagesView';
import Modal from '../ui/Modal';
import Input from '../ui/Input';

// --- Task Management Components ---

const TaskFormModal: React.FC<{ 
    isOpen: boolean, 
    onClose: () => void, 
    teacherClasses: Class[],
    taskToEdit?: Task | null
}> = ({ isOpen, onClose, teacherClasses, taskToEdit }) => {
    const { user } = useAuth();
    const { students, addTask } = useData();
    const [classId, setClassId] = useState(taskToEdit?.classId || '');
    const [assignedStudents, setAssignedStudents] = useState<string[]>([]);
    const [title, setTitle] = useState(taskToEdit?.title || '');
    const [description, setDescription] = useState(taskToEdit?.description || '');
    const [dueDate, setDueDate] = useState(taskToEdit?.dueDate ? new Date(taskToEdit.dueDate).toISOString().substring(0, 10) : '');
    const [priority, setPriority] = useState<Task['priority']>(taskToEdit?.priority || 'Medium');
    
    const studentsInClass = useMemo(() => students.filter(s => s.classId === classId), [classId, students]);

    const handleStudentCheck = (studentId: string) => {
        setAssignedStudents(prev => 
            prev.includes(studentId) ? prev.filter(id => id !== studentId) : [...prev, studentId]
        );
    };

    const handleSelectAll = () => {
        setAssignedStudents(studentsInClass.map(s => s.id));
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (!user || !classId || assignedStudents.length === 0) return;
        
        // In a real app, you would handle editing differently
        if (taskToEdit) {
            console.log("Editing task", taskToEdit.id); // Placeholder
        } else {
            addTask({
                title,
                description,
                classId,
                creatorId: user.id,
                dueDate: new Date(dueDate).toISOString(),
                priority
            }, assignedStudents);
        }
        onClose();
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose}>
            <form onSubmit={handleSubmit} className="space-y-4">
                <h3 className="text-xl font-bold">{taskToEdit ? "Edit Task" : "Create New Task"}</h3>
                <Input id="title" label="Task Title" value={title} onChange={e => setTitle(e.target.value)} required />
                <div>
                    <label htmlFor="description" className="block mb-2 text-sm font-medium text-[rgb(var(--text-color))]">Description</label>
                    <textarea id="description" value={description} onChange={e => setDescription(e.target.value)} rows={3} className="bg-[rgba(var(--text-color),0.02)] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] sm:text-sm rounded-lg focus:ring-1 focus:ring-[rgb(var(--ring-color))] focus:border-[rgb(var(--primary-color))] block w-full p-2.5" />
                </div>
                <Select id="class" label="Assign to Class" value={classId} onChange={e => setClassId(e.target.value)} required>
                    <option value="">-- Select a Class --</option>
                    {teacherClasses.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </Select>
                {classId && (
                    <div>
                        <label className="block mb-2 text-sm font-medium">Assign to Students</label>
                        <div className="max-h-40 overflow-y-auto border border-[rgb(var(--border-color))] rounded-lg p-2 space-y-1">
                            <Button type="button" size="sm" variant="secondary" onClick={handleSelectAll}>Select All</Button>
                            {studentsInClass.map(s => (
                                <div key={s.id} className="flex items-center">
                                    <input type="checkbox" id={`student-${s.id}`} checked={assignedStudents.includes(s.id)} onChange={() => handleStudentCheck(s.id)} className="w-4 h-4 text-[rgb(var(--primary-color))] bg-[rgb(var(--subtle-background-color))] border-[rgb(var(--border-color))] rounded focus:ring-[rgb(var(--primary-color))]" />
                                    <label htmlFor={`student-${s.id}`} className="ml-2 text-sm font-medium">{s.name}</label>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                <Input id="dueDate" label="Due Date" type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} required />
                <Select id="priority" label="Priority" value={priority} onChange={e => setPriority(e.target.value as Task['priority'])}>
                    <option>Low</option>
                    <option>Medium</option>
                    <option>High</option>
                </Select>
                <div className="flex justify-end gap-2 pt-4">
                    <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button type="submit">{taskToEdit ? "Save Changes" : "Create Task"}</Button>
                </div>
            </form>
        </Modal>
    );
};

const TaskDetailView: React.FC<{ task: Task, onBack: () => void }> = ({ task, onBack }) => {
    const { studentTasks, students, classes } = useData();
    const relevantStudentTasks = studentTasks.filter(st => st.taskId === task.id);
    const className = classes.find(c => c.id === task.classId)?.name || 'Unknown Class';
    
    const studentsWithStatus = relevantStudentTasks.map(st => {
        const student = students.find(s => s.id === st.studentId);
        return {
            ...st,
            studentName: student?.name || 'Unknown Student'
        }
    });

    const completionPercent = relevantStudentTasks.length > 0 ? (relevantStudentTasks.filter(st => st.status === 'Completed').length / relevantStudentTasks.length) * 100 : 0;

    const priorityColor = {
        High: 'bg-[rgb(var(--danger-color))]',
        Medium: 'bg-[rgb(var(--warning-color))]',
        Low: 'bg-[rgb(var(--success-color))]'
    };

    return (
        <Card>
            <div className="flex justify-between items-start">
                <div>
                    <h2 className="text-2xl font-bold">{task.title}</h2>
                    <p className="text-sm text-[rgb(var(--text-secondary-color))]">For {className} | Due: {new Date(task.dueDate).toLocaleDateString()}</p>
                </div>
                <Button onClick={onBack} variant="secondary">Back to List</Button>
            </div>
            <div className="mt-4 flex items-center gap-2">
                <span className={`px-2 py-1 text-xs font-semibold text-[rgb(var(--primary-text-color))] rounded-full ${priorityColor[task.priority]}`}>{task.priority}</span>
            </div>
            <p className="mt-4 text-[rgb(var(--text-color))]">{task.description}</p>

            <div className="mt-6">
                <h3 className="font-bold text-lg mb-2">Completion Progress</h3>
                <div className="w-full bg-[rgb(var(--subtle-background-color))] rounded-full">
                    <div className="bg-[rgb(var(--primary-color))] text-xs font-medium text-[rgb(var(--primary-text-color))] text-center p-0.5 leading-none rounded-full" style={{ width: `${completionPercent}%` }}>
                        {completionPercent.toFixed(0)}%
                    </div>
                </div>
            </div>

            <div className="mt-6">
                 <h3 className="font-bold text-lg mb-2">Student Status</h3>
                 <ul className="space-y-2 max-h-80 overflow-y-auto">
                    {studentsWithStatus.map(st => (
                        <li key={st.id} className="flex justify-between items-center p-2 bg-[rgb(var(--subtle-background-color))] rounded-lg">
                            <span>{st.studentName}</span>
                            <span className={`px-2 py-1 text-xs font-semibold rounded-full ${st.status === 'Completed' ? 'bg-[rgb(var(--success-subtle-color))] text-[rgb(var(--success-text-color))]' : 'bg-[rgb(var(--warning-subtle-color))] text-[rgb(var(--warning-text-color))]'}`}>{st.status}</span>
                        </li>
                    ))}
                 </ul>
            </div>
        </Card>
    )
}

const TeacherTaskPage: React.FC<{ teacherClasses: Class[] }> = ({ teacherClasses }) => {
    const { user } = useAuth();
    const { tasks, studentTasks, deleteTask } = useData();
    const [isModalOpen, setModalOpen] = useState(false);
    const [view, setView] = useState<{ type: 'list' | 'detail', taskId?: string }>({ type: 'list' });

    const teacherTasks = tasks.filter(t => t.creatorId === user?.id);

    const handleViewDetails = (taskId: string) => {
        setView({ type: 'detail', taskId });
    };

    if (view.type === 'detail' && view.taskId) {
        const selectedTask = tasks.find(t => t.id === view.taskId);
        return selectedTask ? <TaskDetailView task={selectedTask} onBack={() => setView({ type: 'list' })} /> : <div>Task not found</div>;
    }
    
    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold">Task Management</h2>
                <Button onClick={() => setModalOpen(true)}>Create New Task</Button>
            </div>
            <Card>
                <div className="space-y-4">
                    {teacherTasks.length > 0 ? teacherTasks.map(task => {
                        const assignedCount = studentTasks.filter(st => st.taskId === task.id).length;
                        const completedCount = studentTasks.filter(st => st.taskId === task.id && st.status === 'Completed').length;
                        return (
                            <div key={task.id} className="p-4 rounded-lg bg-[rgb(var(--subtle-background-color))] flex justify-between items-center">
                                <div>
                                    <h4 className="font-bold">{task.title}</h4>
                                    <p className="text-sm text-[rgb(var(--text-secondary-color))]">Due: {new Date(task.dueDate).toLocaleDateString()} | {completedCount}/{assignedCount} Completed</p>
                                </div>
                                <div className="flex gap-2">
                                    <Button onClick={() => handleViewDetails(task.id)} size="sm" variant="secondary">View</Button>
                                    <Button onClick={() => deleteTask(task.id)} size="sm" variant="danger">Delete</Button>
                                </div>
                            </div>
                        )
                    }) : <p>No tasks created yet. Click "Create New Task" to get started.</p>}
                </div>
            </Card>
            <TaskFormModal isOpen={isModalOpen} onClose={() => setModalOpen(false)} teacherClasses={teacherClasses} />
        </div>
    );
};


// --- Original Dashboard Components ---

const AttendanceManager: React.FC<{ classId: string, onBack: () => void }> = ({ classId, onBack }) => {
    const { students } = useData();
    const classStudents = students.filter(s => s.classId === classId);
    return (
        <Card>
            <h3 className="text-xl font-bold mb-4">Manage Attendance for Class {classId}</h3>
            <ul>{classStudents.map(s => <li key={s.id}>{s.name} - <button className="text-[rgb(var(--danger-color))] text-sm">Delete Last Record</button></li>)}</ul>
            <Button onClick={onBack} variant="secondary" className="mt-4">Back to Class</Button>
        </Card>
    );
};
const MarksManager: React.FC<{ classId: string, onBack: () => void }> = ({ classId, onBack }) => (
    <Card>
        <h3 className="text-xl font-bold mb-4">Manage Marks for Class {classId}</h3>
        <Button onClick={onBack} variant="secondary" className="mt-4">Back to Class</Button>
    </Card>
);
const DocumentUploader: React.FC = () => (
    <Card>
        <h3 className="text-xl font-bold mb-4">Upload General Document (PDF)</h3>
        <div className="border-2 border-dashed border-[rgb(var(--border-color))] rounded-lg p-8 text-center text-[rgb(var(--text-secondary-color))]">
            <p>Drag & Drop your PDF here</p>
        </div>
    </Card>
);
const ModelPaperUploader: React.FC = () => (
    <Card>
        <h3 className="text-xl font-bold mb-4">Upload Model Paper</h3>
        <form className="space-y-4">
            <Input id="subject" label="Subject Name" />
            <Input id="exam" label="Exam Name (e.g., Midterm 1)" />
            <Input id="year" label="Year" type="number" />
            <Input id="file" type="file" />
            <Button>Upload Model Paper</Button>
        </form>
    </Card>
);
const DepartmentManager: React.FC = () => {
    const { teachers, deleteUser } = useData();
    return (
        <Card>
            <h3 className="text-xl font-bold mb-4">Manage Department Teachers</h3>
            <ul className="space-y-2">
                {teachers.map(t => (
                    <li key={t.id} className="flex justify-between items-center p-2 bg-[rgb(var(--subtle-background-color))] rounded">
                        <span>{t.name} - {t.department}</span>
                        <Button onClick={() => deleteUser(t.id)} variant="danger" size="sm">Delete</Button>
                    </li>
                ))}
            </ul>
             <Button className="mt-4">Add Teacher to Department</Button>
        </Card>
    );
};

const AddStudentForm: React.FC<{ classId: string, onClose: () => void }> = ({ classId, onClose }) => {
    // In a real app, this would call a context function to add the student
    return (
         <form className="space-y-4">
            <h3 className="text-lg font-bold">Add Student to Class {classId}</h3>
            <Input id="name" label="Student Name" required />
            <Input id="email" label="Student Email" type="email" required />
            <div className="flex justify-end gap-2">
                <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                <Button type="submit">Add Student</Button>
            </div>
        </form>
    )
}

const ClassView: React.FC<{ classObj: Class, setView: (view: string) => void }> = ({ classObj, setView }) => {
    const { students } = useData();
    const [isAddStudentModalOpen, setAddStudentModalOpen] = useState(false);
    const classStudents = students.filter(s => classObj.studentIds.includes(s.id));
    
    return (
        <div className="space-y-6">
             <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold">Class: {classObj.name}</h2>
                 <Button onClick={() => setAddStudentModalOpen(true)}>Add Student</Button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Button onClick={() => setView('attendance')} className="p-6 text-left">Manage Attendance</Button>
                <Button onClick={() => setView('marks')} className="p-6 text-left">Manage Marks</Button>
            </div>
            <Card>
                <h3 className="text-xl font-bold mb-4">Students ({classStudents.length})</h3>
                <ul className="space-y-2">
                    {classStudents.map(s => <li key={s.id} className="p-2 bg-[rgb(var(--subtle-background-color))] rounded">{s.name}</li>)}
                </ul>
            </Card>
            <Modal isOpen={isAddStudentModalOpen} onClose={() => setAddStudentModalOpen(false)}>
                <AddStudentForm classId={classObj.id} onClose={() => setAddStudentModalOpen(false)} />
            </Modal>
        </div>
    );
};


// --- Main Component ---

const Icon = ({ path }: { path: string }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
        <path strokeLinecap="round" strokeLinejoin="round" d={path} />
    </svg>
);

const TeacherDashboard: React.FC = () => {
  const [activeItem, setActiveItem] = useState('Dashboard');
  const [selectedClassId, setSelectedClassId] = useState<string | null>(null);
  const [currentView, setCurrentView] = useState('dashboard'); // dashboard, class, attendance, marks
  const [showMessages, setShowMessages] = useState(false);
  
  const { user } = useAuth();
  const { classes } = useData();
  
  const teacherClasses = useMemo(() => 
    classes.filter(c => c.teacherIds.includes(user!.id)),
    [classes, user]
  );

  const selectedClass = useMemo(() => 
    selectedClassId ? classes.find(c => c.id === selectedClassId) : null, 
    [selectedClassId, classes]
  );
  
  const handleSelectClass = (classId: string) => {
    setSelectedClassId(classId);
    setCurrentView('class');
  };

  const resetToDashboard = () => {
      setSelectedClassId(null);
      setCurrentView('dashboard');
  }

  const navItems = [
    { name: 'Dashboard', icon: <Icon path="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1.5-1.5m1.5 1.5l1.5-1.5m0 0l1.5 1.5m-1.5-1.5l-1.5 1.5" /> },
    { name: 'Upload PDF', icon: <Icon path="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /> },
    { name: 'Upload Model Paper', icon: <Icon path="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /> },
    { name: 'Announcements', icon: <Icon path="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 01-4.5-4.5V7.5a4.5 4.5 0 014.5-4.5h7.5a4.5 4.5 0 014.5 4.5v3.84" /> }
  ];
  
  if (user?.role === UserRole.Dean) {
    navItems.splice(1, 0, { name: 'Department Mgmt', icon: <Icon path="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.512 2.72a3 3 0 01-4.682-2.72 9.094 9.094 0 013.741-.479m-4.26 9.574a4.5 4.5 0 01-.223-1.99a4.5 4.5 0 01.223-1.99m13.486 0a4.5 4.5 0 00-.223-1.99a4.5 4.5 0 00.223-1.99m-13.486 0a4.5 4.5 0 00.223 1.99" /> },
    { name: 'Task Management', icon: <Icon path="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /> });
  } else {
    navItems.splice(1, 0, { name: 'Task Management', icon: <Icon path="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /> });
  }

  const breadcrumbs = [
      { name: 'Dashboard', action: resetToDashboard },
      ...(selectedClassId ? [{ name: selectedClass?.name || 'Class', action: () => setCurrentView('class') }] : []),
      ...(currentView === 'attendance' ? [{ name: 'Attendance' }] : []),
      ...(currentView === 'marks' ? [{ name: 'Marks' }] : []),
  ];

  const renderContent = () => {
    if (showMessages) {
        return <MessagesView />;
    }
    
    switch (activeItem) {
        case 'Dashboard':
            if (currentView === 'class' && selectedClass) return <ClassView classObj={selectedClass} setView={setCurrentView} />;
            if (currentView === 'attendance' && selectedClassId) return <AttendanceManager classId={selectedClassId} onBack={() => setCurrentView('class')} />;
            if (currentView === 'marks' && selectedClassId) return <MarksManager classId={selectedClassId} onBack={() => setCurrentView('class')} />;
            
            // Default Dashboard View
            return (
              <div className="space-y-6">
                <h2 className="text-3xl font-bold">Your Classes</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {teacherClasses.map(c => (
                    <Card key={c.id} className="hover:shadow-lg transition-shadow">
                      <h3 className="font-bold text-xl">{c.name}</h3>
                      <p className="text-sm text-[rgb(var(--text-secondary-color))]">{c.studentIds.length} Students</p>
                      <Button onClick={() => handleSelectClass(c.id)} className="mt-4 w-full">Manage Class</Button>
                    </Card>
                  ))}
                </div>
              </div>
            );
        case 'Department Mgmt':
            return <DepartmentManager />;
        case 'Task Management':
            return <TeacherTaskPage teacherClasses={teacherClasses} />;
        case 'Upload PDF':
            return <DocumentUploader />;
        case 'Upload Model Paper':
            return <ModelPaperUploader />;
        case 'Announcements':
            return <div>Announcements Coming Soon</div>;
        default:
            return <div>Select an item from the sidebar</div>;
    }
  };

  return (
    <Layout navItems={navItems} activeItem={activeItem} setActiveItem={setActiveItem} setShowMessages={setShowMessages}>
        <div className="mb-4">
            <nav className="flex" aria-label="Breadcrumb">
                <ol className="inline-flex items-center space-x-1 md:space-x-3">
                    {breadcrumbs.map((crumb, index) => (
                        <li key={crumb.name} className="inline-flex items-center">
                            {index > 0 && <svg className="w-6 h-6 text-[rgb(var(--text-secondary-color))]" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd"></path></svg>}
                            <button onClick={crumb.action} disabled={!crumb.action} className={`text-sm font-medium ${index === breadcrumbs.length - 1 ? 'text-[rgb(var(--text-secondary-color))]' : 'text-[rgb(var(--primary-color))] hover:text-[rgb(var(--primary-color-dark))]'}`}>
                                {crumb.name}
                            </button>
                        </li>
                    ))}
                </ol>
            </nav>
        </div>
        {renderContent()}
    </Layout>
  );
};

export default TeacherDashboard;

--- END OF FILE components/teacher/TeacherDashboard.tsx ---


--- START OF FILE components/student/StudentDashboard.tsx ---

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import Layout from '../Layout';
import Card from '../ui/Card';
import Button from '../ui/Button';
import AttendanceBarChart from '../charts/AttendanceBarChart';
import SubjectPieChart from '../charts/SubjectPieChart';
import { generateStudySchedule } from '../../services/geminiService';
import { useAuth } from '../../hooks/useAuth';
import { useData } from '../../context/DataContext';
import { Mark, StudySession, StudentTask, Task } from '../../types';
import { ATTENDANCE_THRESHOLD } from '../../constants';
import Select from '../ui/Select';

// --- New Student Tasks View ---
const StudentTasksView: React.FC = () => {
    const { user } = useAuth();
    const { studentTasks, tasks, teachers, updateStudentTaskStatus } = useData();

    const myTasks = useMemo(() => {
        return studentTasks
            .filter(st => st.studentId === user?.id)
            .map(st => {
                const task = tasks.find(t => t.id === st.taskId);
                const creator = teachers.find(t => t.id === task?.creatorId);
                return { ...st, task, creatorName: creator?.name || 'Unknown Teacher' };
            })
            .filter(st => st.task); // Filter out any student tasks with no matching task
    }, [user, studentTasks, tasks, teachers]);

    const activeTasks = myTasks.filter(t => t.status !== 'Completed');
    const completedTasks = myTasks.filter(t => t.status === 'Completed');

    const priorityColor = {
        High: 'border-[rgb(var(--danger-color))]',
        Medium: 'border-[rgb(var(--warning-color))]',
        Low: 'border-[rgb(var(--success-color))]'
    };

    const TaskCard: React.FC<{ taskData: (typeof myTasks)[0] }> = ({ taskData }) => (
        <div className={`p-4 rounded-lg bg-[rgb(var(--foreground-color))] border-l-4 ${priorityColor[taskData.task!.priority]}`}>
            <div className="flex justify-between items-start">
                <div>
                    <h3 className="font-bold text-lg">{taskData.task!.title}</h3>
                    <p className="text-sm text-[rgb(var(--text-secondary-color))]">By {taskData.creatorName} | Due: {new Date(taskData.task!.dueDate).toLocaleDateString()}</p>
                </div>
                <select 
                    value={taskData.status} 
                    onChange={(e) => updateStudentTaskStatus(taskData.id, e.target.value as StudentTask['status'])}
                    className="bg-[rgb(var(--subtle-background-color))] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] text-sm rounded-lg focus:ring-[rgb(var(--primary-color))] focus:border-[rgb(var(--primary-color))]"
                >
                    <option>To Do</option>
                    <option>In Progress</option>
                    <option>Completed</option>
                </select>
            </div>
            <p className="mt-2 text-[rgb(var(--text-color))]">{taskData.task!.description}</p>
        </div>
    );
    
    return (
        <div className="space-y-6">
            <div>
                <h2 className="text-2xl font-bold mb-4">Active Tasks ({activeTasks.length})</h2>
                <div className="space-y-4">
                    {activeTasks.length > 0 ? (
                        activeTasks.map(st => <TaskCard key={st.id} taskData={st} />)
                    ) : (
                        <p>No active tasks. Great job!</p>
                    )}
                </div>
            </div>
             <div>
                <h2 className="text-2xl font-bold mb-4">Completed Tasks ({completedTasks.length})</h2>
                <div className="space-y-4">
                    {completedTasks.length > 0 ? (
                        completedTasks.map(st => <TaskCard key={st.id} taskData={st} />)
                    ) : (
                        <p>No tasks completed yet.</p>
                    )}
                </div>
            </div>
        </div>
    );
}


// --- Original Dashboard Components ---

const DashboardView: React.FC<{ studentMarks: Mark[], studentAttendance: any, onGenerateSchedule: () => void }> = ({ studentMarks, studentAttendance, onGenerateSchedule }) => {
    const { user } = useAuth();
    const overallAttendance = studentAttendance.total > 0 ? ((studentAttendance.present / studentAttendance.total) * 100).toFixed(1) : 0;
    const lowAttendanceSubjects = studentAttendance.subjectWise.filter((s:any) => s.attendance < ATTENDANCE_THRESHOLD);

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <Card className="lg:col-span-2">
                <h2 className="text-xl font-bold mb-4">Welcome back, {user?.name}!</h2>
                <p className="text-[rgb(var(--text-secondary-color))]">Here's a quick summary of your academic progress.</p>
            </Card>
            <Card>
                <h3 className="font-bold text-lg mb-2">AI Study Planner</h3>
                <p className="text-sm text-[rgb(var(--text-secondary-color))] mb-4">Get a personalized study schedule for today based on your performance.</p>
                <Button onClick={onGenerateSchedule} className="w-full">Generate Today's Plan</Button>
            </Card>
             <Card>
                <h3 className="font-bold text-lg mb-2">Overall Attendance</h3>
                <p className={`text-4xl font-bold ${parseFloat(overallAttendance as string) < ATTENDANCE_THRESHOLD ? 'text-[rgb(var(--danger-color))]' : 'text-[rgb(var(--success-color))]'}`}>{overallAttendance}%</p>
                {lowAttendanceSubjects.length > 0 && 
                    <p className="text-sm text-[rgb(var(--warning-color))] mt-2">Attention needed in: {lowAttendanceSubjects.map((s:any) => s.name).join(', ')}</p>
                }
            </Card>
             <Card className="lg:col-span-2">
                <h3 className="font-bold text-lg mb-2">Recent Marks Overview</h3>
                 <div className="h-48 overflow-y-auto">
                    <ul className="space-y-2">
                    {studentMarks.map(m => (
                        <li key={m.subject} className="flex justify-between items-center p-2 rounded-lg bg-[rgb(var(--subtle-background-color))]">
                            <span className="font-medium">{m.subject}</span>
                            <span className={`font-bold ${m.marks/m.maxMarks*100 < 60 ? 'text-[rgb(var(--danger-color))]' : 'text-[rgb(var(--success-color))]'}`}>{m.marks}/{m.maxMarks}</span>
                        </li>
                    ))}
                    </ul>
                </div>
            </Card>
        </div>
    );
};

const AttendanceView: React.FC<{ studentAttendance: any }> = ({ studentAttendance }) => (
    <Card>
        <h2 className="text-xl font-bold mb-4">Attendance Details</h2>
        <AttendanceBarChart data={studentAttendance.subjectWise} />
    </Card>
);

const MarksView: React.FC<{ studentMarks: Mark[] }> = ({ studentMarks }) => {
    const pieChartData = studentMarks.map(m => ({ name: m.subject, value: m.marks }));
    return (
        <Card>
            <h2 className="text-xl font-bold mb-4">Marks Distribution</h2>
            <SubjectPieChart data={pieChartData} />
        </Card>
    );
};

const ScheduleView: React.FC<{ studentMarks: Mark[] }> = ({ studentMarks }) => {
    const [schedule, setSchedule] = useState<StudySession[]>([]);
    const [isLoading, setIsLoading] = useState(false);

    const handleGenerateSchedule = useCallback(async () => {
        setIsLoading(true);
        const availableSlots = ['09:00-12:00', '13:00-16:00', '19:00-21:00'];
        const result = await generateStudySchedule(studentMarks, availableSlots);
        setSchedule(result);
        setIsLoading(false);
    }, [studentMarks]);
    
    useEffect(() => {
        handleGenerateSchedule();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    return (
        <Card>
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">AI Generated Study Schedule</h2>
                <Button onClick={handleGenerateSchedule} disabled={isLoading}>{isLoading ? 'Generating...' : 'Regenerate'}</Button>
            </div>
            {isLoading ? (
                 <div className="flex justify-center items-center h-64">
                    <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[rgb(var(--primary-color))]"></div>
                 </div>
            ) : (
                <div className="space-y-4">
                    {schedule.map((session, index) => (
                        <div key={index} className="p-4 rounded-lg bg-[rgb(var(--subtle-background-color))] border-l-4 border-[rgb(var(--primary-color))]">
                            <div className="flex justify-between items-center">
                                <h3 className="font-bold text-lg">{session.subject}</h3>
                                <span className="text-sm font-mono bg-[rgba(var(--primary-color),0.1)] text-[rgb(var(--primary-color))] px-2 py-1 rounded">{session.startTime} - {session.endTime}</span>
                            </div>
                            <p className="text-[rgb(var(--text-color))] mt-1">{session.topic}</p>
                            <p className="text-sm text-[rgb(var(--text-secondary-color))] mt-2"><em>Reason: {session.reason}</em></p>
                        </div>
                    ))}
                </div>
            )}
        </Card>
    );
};


// --- Main Dashboard Component ---

const Icon = ({ path }: { path: string }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
        <path strokeLinecap="round" strokeLinejoin="round" d={path} />
    </svg>
);


const StudentDashboard: React.FC = () => {
  const [activeItem, setActiveItem] = useState('Dashboard');
  const { user } = useAuth();
  const { marks, attendance } = useData();

  // In a real app, this data would be fetched via API based on the user's ID
  const studentMarks = marks.filter(m => m.studentId === user?.id);
  const studentAttendanceRecords = attendance.filter(a => a.studentId === user?.id);

  // Process data for charts
  const studentAttendance = {
      total: studentAttendanceRecords.length,
      present: studentAttendanceRecords.filter(a => a.status === 'present').length,
      subjectWise: [ // This would be more complex in a real app
          { name: 'Data Structures', attendance: 80 },
          { name: 'Algorithms', attendance: 90 },
          { name: 'Database Systems', attendance: 70 },
      ]
  };
  
  const navItems = [
    { name: 'Dashboard', icon: <Icon path="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1.5-1.5m1.5 1.5l1.5-1.5m0 0l1.5 1.5m-1.5-1.5l-1.5 1.5" /> },
    { name: 'Attendance', icon: <Icon path="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /> },
    { name: 'Marks', icon: <Icon path="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /> },
    { name: 'My Tasks', icon: <Icon path="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /> },
    { name: 'Schedule', icon: <Icon path="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /> }
  ];

  const renderContent = () => {
    switch (activeItem) {
      case 'Dashboard':
        return <DashboardView studentMarks={studentMarks} studentAttendance={studentAttendance} onGenerateSchedule={() => setActiveItem('Schedule')} />;
      case 'Attendance':
        return <AttendanceView studentAttendance={studentAttendance} />;
      case 'Marks':
        return <MarksView studentMarks={studentMarks} />;
      case 'My Tasks':
        return <StudentTasksView />;
      case 'Schedule':
        return <ScheduleView studentMarks={studentMarks} />;
      default:
        return <DashboardView studentMarks={studentMarks} studentAttendance={studentAttendance} onGenerateSchedule={() => setActiveItem('Schedule')} />;
    }
  };

  return (
    <Layout navItems={navItems} activeItem={activeItem} setActiveItem={setActiveItem}>
      {renderContent()}
    </Layout>
  );
};

export default StudentDashboard;

--- END OF FILE components/student/StudentDashboard.tsx ---


--- START OF FILE components/parent/ParentDashboard.tsx ---

import React, { useState, useMemo } from 'react';
import Layout from '../Layout';
import Card from '../ui/Card';
import AttendanceBarChart from '../charts/AttendanceBarChart';
import SubjectPieChart from '../charts/SubjectPieChart';
import { useAuth } from '../../hooks/useAuth';
import { mockUsers, mockMarks, mockAttendance, mockAnnouncements } from '../../data/mock';
import { Parent, Student, Mark, AttendanceRecord } from '../../types';
import { ATTENDANCE_THRESHOLD } from '../../constants';


const ChildSwitcher: React.FC<{
  childrenData: Student[];
  selectedChildId: string;
  setSelectedChildId: (id: string) => void;
}> = ({ childrenData, selectedChildId, setSelectedChildId }) => {
  return (
    <div className="mb-6">
        <label htmlFor="child-select" className="block text-sm font-medium text-[rgb(var(--text-secondary-color))] mb-2">
            Viewing Dashboard For:
        </label>
        <select
            id="child-select"
            value={selectedChildId}
            onChange={(e) => setSelectedChildId(e.target.value)}
            className="w-full max-w-xs bg-[rgb(var(--foreground-color))] border border-[rgb(var(--border-color))] rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[rgb(var(--primary-color))] focus:border-[rgb(var(--primary-color))]"
        >
            {childrenData.map((child) => (
                <option key={child.id} value={child.id}>
                    {child.name}
                </option>
            ))}
        </select>
    </div>
  );
};

const ParentDashboardContent: React.FC<{ child: Student }> = ({ child }) => {
    const childMarks = useMemo(() => mockMarks.filter(m => m.studentId === child.id), [child.id]);
    const childAttendance = useMemo(() => mockAttendance.filter(a => a.studentId === child.id), [child.id]);

    const attendanceData = useMemo(() => {
        const total = childAttendance.length;
        const present = childAttendance.filter(a => a.status === 'present').length;
        const overall = total > 0 ? ((present / total) * 100) : 0;
        return {
            overall,
            subjectWise: [ // Mock data, would be calculated from a richer dataset
                { name: 'Data Structures', attendance: 80 },
                { name: 'Algorithms', attendance: 90 },
                { name: 'Database Systems', attendance: 70 },
            ]
        };
    }, [childAttendance]);

    const marksPieData = useMemo(() => childMarks.map(m => ({ name: m.subject, value: m.marks })), [childMarks]);
    
    return (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card>
                    <h3 className="font-bold text-lg mb-2">Overall Attendance</h3>
                    <p className={`text-4xl font-bold ${attendanceData.overall < ATTENDANCE_THRESHOLD ? 'text-[rgb(var(--danger-color))]' : 'text-[rgb(var(--success-color))]'}`}>
                        {attendanceData.overall.toFixed(1)}%
                    </p>
                </Card>
                <Card>
                    <h3 className="font-bold text-lg mb-2">Announcements</h3>
                    <div className="h-24 overflow-y-auto">
                        <ul className="space-y-2">
                        {mockAnnouncements.map(ann => (
                            <li key={ann.id} className="text-sm p-2 rounded bg-[rgba(var(--primary-color),0.1)]">
                                <strong>{ann.teacherName}:</strong> {ann.content}
                            </li>
                        ))}
                        </ul>
                    </div>
                </Card>
            </div>
             <Card>
                <h2 className="text-xl font-bold mb-4">Attendance Details</h2>
                <AttendanceBarChart data={attendanceData.subjectWise} />
            </Card>
             <Card>
                <h2 className="text-xl font-bold mb-4">Marks Distribution</h2>
                <SubjectPieChart data={marksPieData} />
            </Card>
        </div>
    );
};

const Icon = ({ path }: { path: string }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
        <path strokeLinecap="round" strokeLinejoin="round" d={path} />
    </svg>
);


const ParentDashboard: React.FC = () => {
  const { user } = useAuth();
  const parentUser = user as Parent;
  
  const childrenData = useMemo(() => 
    mockUsers.filter(u => parentUser.childIds.includes(u.id)) as Student[],
    [parentUser.childIds]
  );
  
  const [selectedChildId, setSelectedChildId] = useState(childrenData[0]?.id || '');
  
  const selectedChild = childrenData.find(c => c.id === selectedChildId);

  // Parent dashboard is simpler, so we can use a static nav item and just change content
  const [activeItem, setActiveItem] = useState('Dashboard');
  const navItems = [
    { name: 'Dashboard', icon: <Icon path="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.512 2.72a3 3 0 01-4.682-2.72 9.094 9.094 0 013.741-.479m-4.26 9.574a4.5 4.5 0 01-.223-1.99a4.5 4.5 0 01.223-1.99m13.486 0a4.5 4.5 0 00-.223-1.99a4.5 4.5 0 00.223-1.99m-13.486 0a4.5 4.5 0 00.223 1.99" /> },
  ];

  return (
    <Layout navItems={navItems} activeItem={activeItem} setActiveItem={setActiveItem}>
      {childrenData.length > 1 && (
        <ChildSwitcher 
            childrenData={childrenData} 
            selectedChildId={selectedChildId} 
            setSelectedChildId={setSelectedChildId} 
        />
      )}
      {selectedChild ? (
          <ParentDashboardContent child={selectedChild} />
      ) : (
          <Card><p>No child selected or data not found.</p></Card>
      )}
    </Layout>
  );
};

export default ParentDashboard;

--- END OF FILE components/parent/ParentDashboard.tsx ---


--- START OF FILE components/ui/Select.tsx ---

import React from 'react';

interface SelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  children: React.ReactNode;
}

const Select: React.FC<SelectProps> = ({ label, id, children, ...props }) => {
  return (
    <div>
      {label && <label htmlFor={id} className="block mb-2 text-sm font-medium text-[rgb(var(--text-color))]">{label}</label>}
      <select
        id={id}
        className="bg-[rgb(var(--subtle-background-color))] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] sm:text-sm rounded-lg focus:ring-1 focus:ring-[rgb(var(--ring-color))] focus:border-[rgb(var(--primary-color))] block w-full p-2.5"
        {...props}
      >
        {children}
      </select>
    </div>
  );
};

export default Select;

--- END OF FILE components/ui/Select.tsx ---


--- START OF FILE context/ThemeContext.tsx ---

import React, { createContext, useState, useContext, ReactNode, useLayoutEffect } from 'react';

type Theme = 'light-white' | 'light-pink' | 'light-green' | 'light-brown' | 'black';

interface ThemeContextType {
  theme: Theme;
  setTheme: (theme: Theme) => void;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

const themes: Record<Theme, Record<string, string>> = {
  'light-white': {
    '--primary-color': '96 165 250', '--primary-color-dark': '59 130 246', '--ring-color': '96 165 250',
    '--background-color': '243 244 246', '--foreground-color': '255 255 255', '--subtle-background-color': '249 250 251',
    '--text-color': '17 24 39', '--text-secondary-color': '75 85 99', '--primary-text-color': '255 255 255',
    '--border-color': '229 231 235',
    '--danger-color': '239 68 68', '--danger-color-dark': '220 38 38', '--danger-subtle-color': '254 226 226', '--danger-text-color': '153 27 27',
    '--success-color': '34 197 94', '--success-subtle-color': '220 252 231', '--success-text-color': '21 128 61',
    '--warning-color': '234 179 8', '--warning-subtle-color': '254 249 195', '--warning-text-color': '180 83 9',
  },
  'light-pink': {
    '--primary-color': '236 72 153', '--primary-color-dark': '219 39 119', '--ring-color': '236 72 153',
    '--background-color': '253 242 248', '--foreground-color': '255 255 255', '--subtle-background-color': '252 232 242',
    '--text-color': '131 24 67', '--text-secondary-color': '157 23 77', '--primary-text-color': '255 255 255',
    '--border-color': '251 207 232',
    '--danger-color': '239 68 68', '--danger-color-dark': '220 38 38', '--danger-subtle-color': '254 226 226', '--danger-text-color': '153 27 27',
    '--success-color': '34 197 94', '--success-subtle-color': '220 252 231', '--success-text-color': '21 128 61',
    '--warning-color': '234 179 8', '--warning-subtle-color': '254 249 195', '--warning-text-color': '180 83 9',
  },
  'light-green': {
    '--primary-color': '74 222 128', '--primary-color-dark': '34 197 94', '--ring-color': '74 222 128',
    '--background-color': '240 253 244', '--foreground-color': '255 255 255', '--subtle-background-color': '220 252 231',
    '--text-color': '21 94 53', '--text-secondary-color': '22 101 52', '--primary-text-color': '255 255 255',
    '--border-color': '187 247 208',
    '--danger-color': '239 68 68', '--danger-color-dark': '220 38 38', '--danger-subtle-color': '254 226 226', '--danger-text-color': '153 27 27',
    '--success-color': '34 197 94', '--success-subtle-color': '220 252 231', '--success-text-color': '21 128 61',
    '--warning-color': '234 179 8', '--warning-subtle-color': '254 249 195', '--warning-text-color': '180 83 9',
  },
  'light-brown': {
    '--primary-color': '202 138 4', '--primary-color-dark': '161 98 7', '--ring-color': '202 138 4',
    '--background-color': '254 252 232', '--foreground-color': '255 255 255', '--subtle-background-color': '254 249 195',
    '--text-color': '120 53 15', '--text-secondary-color': '124 45 18', '--primary-text-color': '255 255 255',
    '--border-color': '254 240 138',
    '--danger-color': '239 68 68', '--danger-color-dark': '220 38 38', '--danger-subtle-color': '254 226 226', '--danger-text-color': '153 27 27',
    '--success-color': '34 197 94', '--success-subtle-color': '220 252 231', '--success-text-color': '21 128 61',
    '--warning-color': '234 179 8', '--warning-subtle-color': '254 249 195', '--warning-text-color': '180 83 9',
  },
  'black': {
    '--primary-color': '96 165 250', '--primary-color-dark': '59 130 246', '--ring-color': '96 165 250',
    '--background-color': '17 24 39', '--foreground-color': '31 41 55', '--subtle-background-color': '55 65 81',
    '--text-color': '249 250 251', '--text-secondary-color': '156 163 175', '--primary-text-color': '255 255 255',
    '--border-color': '75 85 99',
    '--danger-color': '239 68 68', '--danger-color-dark': '220 38 38', '--danger-subtle-color': '153 27 27', '--danger-text-color': '254 226 226',
    '--success-color': '74 222 128', '--success-subtle-color': '22 101 52', '--success-text-color': '187 247 208',
    '--warning-color': '250 204 21', '--warning-subtle-color': '133 77 14', '--warning-text-color': '254 249 195',
  },
};

export const ThemeProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [theme, setTheme] = useState<Theme>('light-white');

  useLayoutEffect(() => {
    const root = document.documentElement;
    const selectedTheme = themes[theme];
    for (const [key, value] of Object.entries(selectedTheme)) {
        root.style.setProperty(key, value);
    }
  }, [theme]);

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error('useTheme must be used within a ThemeProvider');
  }
  return context;
};

--- END OF FILE context/ThemeContext.tsx ---


--- START OF FILE context/DataContext.tsx ---

import React, { createContext, useState, useContext, ReactNode, useMemo } from 'react';
// FIX: Import Mark and AttendanceRecord types to use in the context.
import { LoggedInUser, Class, Message, Teacher, Student, Parent, Dean, UserRole, Task, StudentTask, Mark, AttendanceRecord } from '../types';
// FIX: Import mockMarks and mockAttendance to provide them through the context.
import { mockUsers, mockClasses, mockMessages as initialMockMessages, mockTasks as initialMockTasks, mockStudentTasks as initialMockStudentTasks, mockMarks, mockAttendance } from '../data/mock';

interface DataContextType {
  users: LoggedInUser[];
  classes: Class[];
  messages: Message[];
  tasks: Task[];
  studentTasks: StudentTask[];
  teachers: (Teacher | Dean)[];
  students: Student[];
  parents: Parent[];
  // FIX: Add marks and attendance to the DataContextType interface.
  marks: Mark[];
  attendance: AttendanceRecord[];
  addMessage: (message: Omit<Message, 'id' | 'timestamp' | 'readBy'>) => void;
  updateMessage: (messageId: string, newContent: string) => void;
  deleteUser: (userId: string) => void;
  addTask: (taskData: Omit<Task, 'id'>, studentIds: string[]) => void;
  deleteTask: (taskId: string) => void;
  updateStudentTaskStatus: (studentTaskId: string, status: StudentTask['status']) => void;
}

const DataContext = createContext<DataContextType | undefined>(undefined);

export const DataProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [users, setUsers] = useState<LoggedInUser[]>(mockUsers);
  const [classes, setClasses] = useState<Class[]>(mockClasses);
  const [messages, setMessages] = useState<Message[]>(initialMockMessages);
  const [tasks, setTasks] = useState<Task[]>(initialMockTasks);
  const [studentTasks, setStudentTasks] = useState<StudentTask[]>(initialMockStudentTasks);
  // FIX: Create state for marks and attendance using mock data.
  const [marks, setMarks] = useState<Mark[]>(mockMarks);
  const [attendance, setAttendance] = useState<AttendanceRecord[]>(mockAttendance);


  const addMessage = (message: Omit<Message, 'id' | 'timestamp' | 'readBy'>) => {
    const newMessage: Message = {
      ...message,
      id: `msg${Date.now()}`,
      timestamp: new Date().toISOString(),
      readBy: [message.senderId],
    };
    setMessages(prev => [newMessage, ...prev]);
  };

  const updateMessage = (messageId: string, newContent: string) => {
    setMessages(prev => prev.map(msg => 
        msg.id === messageId ? { ...msg, content: newContent } : msg
    ));
  };
  
  const deleteUser = (userId: string) => {
    setUsers(prev => prev.filter(user => user.id !== userId));
    // Also remove from classes, etc.
    setClasses(prev => prev.map(c => ({
        ...c,
        teacherIds: c.teacherIds.filter(id => id !== userId),
        studentIds: c.studentIds.filter(id => id !== userId)
    })));
    // Also remove any student tasks they have
    setStudentTasks(prev => prev.filter(st => st.studentId !== userId));
  };
  
  const addTask = (taskData: Omit<Task, 'id'>, studentIds: string[]) => {
    const newTaskId = `task${Date.now()}`;
    const newTask: Task = {
        id: newTaskId,
        ...taskData,
    };
    setTasks(prev => [newTask, ...prev]);

    const newStudentTasks: StudentTask[] = studentIds.map(studentId => ({
        id: `stask${Date.now()}${studentId.slice(-4)}`,
        taskId: newTaskId,
        studentId: studentId,
        status: 'To Do',
    }));
    setStudentTasks(prev => [...prev, ...newStudentTasks]);
  };
  
  const deleteTask = (taskId: string) => {
      setTasks(prev => prev.filter(t => t.id !== taskId));
      setStudentTasks(prev => prev.filter(st => st.taskId !== taskId));
  };

  const updateStudentTaskStatus = (studentTaskId: string, status: StudentTask['status']) => {
    setStudentTasks(prev => prev.map(st => {
        if (st.id === studentTaskId) {
            return {
                ...st,
                status: status,
                completedDate: status === 'Completed' ? new Date().toISOString() : st.completedDate, // Keep old date if toggled away from completed
            };
        }
        return st;
    }));
  };

  const teachers = useMemo(() => users.filter(u => u.role === UserRole.Teacher || u.role === UserRole.Dean) as (Teacher | Dean)[], [users]);
  const students = useMemo(() => users.filter(u => u.role === UserRole.Student) as Student[], [users]);
  const parents = useMemo(() => users.filter(u => u.role === UserRole.Parent) as Parent[], [users]);

  const value = {
    users,
    classes,
    messages,
    tasks,
    studentTasks,
    teachers,
    students,
    parents,
    // FIX: Provide marks and attendance in the context value object.
    marks,
    attendance,
    addMessage,
    updateMessage,
    deleteUser,
    addTask,
    deleteTask,
    updateStudentTaskStatus,
  };

  return (
    <DataContext.Provider value={value}>
      {children}
    </DataContext.Provider>
  );
};

export const useData = () => {
  const context = useContext(DataContext);
  if (context === undefined) {
    throw new Error('useData must be used within a DataProvider');
  }
  return context;
};

--- END OF FILE context/DataContext.tsx ---


--- START OF FILE components/ThemeSwitcher.tsx ---

import React from 'react';
import { useTheme } from '../context/ThemeContext';

const themes = [
    { id: 'light-white', name: 'Default Light' },
    { id: 'light-pink', name: 'Light Pink' },
    { id: 'light-green', name: 'Light Green' },
    { id: 'light-brown', name: 'Light Brown' },
    { id: 'black', name: 'Default Dark' },
];

const ThemeSwitcher: React.FC = () => {
    const { theme, setTheme } = useTheme();

    return (
        <div>
            <select
                value={theme}
                onChange={(e) => setTheme(e.target.value as any)}
                className="bg-[rgb(var(--subtle-background-color))] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] text-sm rounded-lg focus:ring-1 focus:ring-[rgb(var(--ring-color))] focus:border-[rgb(var(--primary-color))] block w-full p-1.5"
                aria-label="Select theme"
            >
                {themes.map((t) => (
                    <option key={t.id} value={t.id}>{t.name}</option>
                ))}
            </select>
        </div>
    );
};

export default ThemeSwitcher;

--- END OF FILE components/ThemeSwitcher.tsx ---


--- START OF FILE components/shared/MessagesView.tsx ---

import React, { useState, useMemo } from 'react';
import { useData } from '../../context/DataContext';
import { useAuth } from '../../hooks/useAuth';
import { UserRole, Message as MessageType } from '../../types';
import Card from '../ui/Card';
import Button from '../ui/Button';
import Select from '../ui/Select';

const MessageBox: React.FC<{ onSend: (targetType: 'class' | 'department', targetId: string, content: string) => void }> = ({ onSend }) => {
    const { user } = useAuth();
    const { classes } = useData();
    const [target, setTarget] = useState('');
    const [content, setContent] = useState('');
    
    const userClasses = classes.filter(c => c.teacherIds.includes(user!.id));
    const userDepartment = (user as any).department;

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (!target || !content) return;
        const [type, id] = target.split(':');
        onSend(type as 'class' | 'department', id, content);
        setContent('');
        setTarget('');
    }

    return (
        <Card className="mb-6">
            <h3 className="text-xl font-bold mb-4">Send a New Message</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
                <Select id="target" value={target} onChange={e => setTarget(e.target.value)} required>
                    <option value="">-- Select Target --</option>
                    {userClasses.map(c => <option key={c.id} value={`class:${c.id}`}>Class: {c.name}</option>)}
                    {userDepartment && <option value={`department:${userDepartment}`}>Department: {userDepartment}</option>}
                </Select>
                 <textarea
                    value={content}
                    onChange={e => setContent(e.target.value)}
                    className="bg-[rgb(var(--subtle-background-color))] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] sm:text-sm rounded-lg focus:ring-1 focus:ring-[rgb(var(--ring-color))] focus:border-[rgb(var(--primary-color))] block w-full p-2.5"
                    placeholder="Your message..."
                    rows={4}
                    required
                ></textarea>
                <Button type="submit">Send Message</Button>
            </form>
        </Card>
    );
};

const Message: React.FC<{ message: MessageType }> = ({ message }) => {
    const { user } = useAuth();
    const { updateMessage } = useData();
    const [isEditing, setIsEditing] = useState(false);
    const [editedContent, setEditedContent] = useState(message.content);

    const canEdit = useMemo(() => {
        if (message.senderId !== user?.id) return false;
        const messageTime = new Date(message.timestamp).getTime();
        const now = Date.now();
        return (now - messageTime) < 15 * 60 * 1000; // 15 minutes
    }, [message, user]);

    const handleUpdate = () => {
        updateMessage(message.id, editedContent);
        setIsEditing(false);
    }
    
    return (
        <div className="p-4 rounded-lg bg-[rgb(var(--foreground-color))] shadow">
            <div className="flex justify-between items-start">
                <div>
                    <p className="font-bold">{message.senderName}</p>
                    <p className="text-sm text-[rgb(var(--text-secondary-color))]">To: {message.targetType === 'class' ? 'Class' : 'Dept'} - {message.targetId}</p>
                </div>
                <span className="text-xs text-[rgb(var(--text-secondary-color))]">{new Date(message.timestamp).toLocaleString()}</span>
            </div>
            {isEditing ? (
                 <div className="mt-2">
                    <textarea 
                        value={editedContent} 
                        onChange={e => setEditedContent(e.target.value)}
                        className="bg-[rgb(var(--subtle-background-color))] border border-[rgb(var(--border-color))] text-[rgb(var(--text-color))] sm:text-sm rounded-lg block w-full p-2.5"
                        rows={3}
                    />
                    <div className="flex gap-2 mt-2">
                        <Button onClick={handleUpdate} size="sm">Save</Button>
                        <Button onClick={() => setIsEditing(false)} variant="secondary" size="sm">Cancel</Button>
                    </div>
                </div>
            ) : (
                <p className="mt-2 text-[rgb(var(--text-color))] whitespace-pre-wrap">{message.content}</p>
            )}
            {!isEditing && canEdit && (
                <div className="text-right mt-2">
                    <button onClick={() => setIsEditing(true)} className="text-xs text-[rgb(var(--primary-color))] hover:underline">Edit</button>
                </div>
            )}
        </div>
    )
}

const MessagesView: React.FC = () => {
    const { user } = useAuth();
    const { messages, addMessage, classes } = useData();

    const relevantMessages = useMemo(() => {
        if (!user) return [];
        return messages.filter(msg => {
            if (user.role === UserRole.Student) {
                const studentClass = classes.find(c => c.studentIds.includes(user.id));
                return msg.targetType === 'class' && msg.targetId === studentClass?.id;
            }
            if (user.role === UserRole.Parent) {
                 const childClasses = classes.filter(c => (user as any).childIds.some((childId: string) => c.studentIds.includes(childId)));
                 return msg.targetType === 'class' && childClasses.some(c => c.id === msg.targetId);
            }
            if (user.role === UserRole.Teacher || user.role === UserRole.Dean) {
                const teacherClasses = classes.filter(c => c.teacherIds.includes(user.id));
                return (msg.targetType === 'department' && msg.targetId === (user as any).department) ||
                       (msg.targetType === 'class' && teacherClasses.some(c => c.id === msg.targetId));
            }
            return false;
        });
    }, [user, messages, classes]);

    const handleSend = (targetType: 'class' | 'department', targetId: string, content: string) => {
        if (!user) return;
        addMessage({ senderId: user.id, senderName: user.name, targetType, targetId, content });
    };

    return (
        <div className="space-y-6">
            {(user?.role === UserRole.Teacher || user?.role === UserRole.Dean) && <MessageBox onSend={handleSend} />}
            <h2 className="text-2xl font-bold">Messages</h2>
            <div className="space-y-4">
                {relevantMessages.length > 0 ? (
                    relevantMessages.map(msg => <Message key={msg.id} message={msg} />)
                ) : (
                    <p>No messages for you yet.</p>
                )}
            </div>
        </div>
    );
};

export default MessagesView;

--- END OF FILE components/shared/MessagesView.tsx ---


--- START OF FILE components/ui/Modal.tsx ---

import React from 'react';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
}

const Modal: React.FC<ModalProps> = ({ isOpen, onClose, children }) => {
  if (!isOpen) return null;

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center"
      onClick={onClose}
    >
      <div 
        className="bg-[rgb(var(--foreground-color))] rounded-lg shadow-xl p-6 w-full max-w-md"
        onClick={e => e.stopPropagation()}
      >
        <div className="flex justify-end">
             <button onClick={onClose} className="text-[rgb(var(--text-secondary-color))] hover:text-[rgb(var(--text-color))]">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        {children}
      </div>
    </div>
  );
};

export default Modal;

--- END OF FILE components/ui/Modal.tsx ---
